<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .title_name {
        text-align: center;
        font-size: 2rem;
        font-weight: 700;
      }

      .form-container {
        max-width: 800px;
        margin: 0 auto;
      }

      body {
        font-family: "Lato", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
        color: #333;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: #333;
        color: #fff;
      }

      header h1 {
        margin: 0;
        font-size: 1.5rem;
      }

      header button {
        background-color: #e63946;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
      }

      header button:hover {
        background-color: #d62828;
      }

      main {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }

      h2 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
        font-weight: 700;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 15px; /* Espaciado entre los elementos del formulario */
      }

      form label {
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
      }

      input,
      select,
      button {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 1rem;
      }

      input:focus,
      select:focus,
      button:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      }

      button {
        background-color: #007bff;
        color: #fff;
        border: none;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #0056b3;
      }

      #jobLogs {
        border: 1px solid #ccc;
        padding: 10px;
        height: 150px;
        overflow-y: auto;
        background-color: #f9f9f9;
        border-radius: 5px;
        margin: 50px 50px;
      }

      footer {
        text-align: center;
        margin-top: 20px;
        color: #666;
      }

      @media (max-width: 4000px) {
        main {
          padding: 15px;
        }

        input,
        select,
        button {
          font-size: 0.9rem;
        }
      }
    </style>

  </head>
  <body onload="initializeForm();">


    <header>
      <h1>Programar Cibtron WB-001</h1>
      <button onclick="logout()">Cerrar sesión</button>
    </header>

    
    <div class="form-container">
    <!-- Formulario para ejecutar el Cloud Run Job y programar el ESP32 -->
    <form id="jobForm" onsubmit="validateForm(event)">
      <h2>Programar Cibtron WB-001</h2>

      <label for="port">Selecciona un puerto:</label>
      <select id="port" name="port">
        <option value="" disabled selected>Esperando puertos...</option>
      </select>

      <label for="USER">USER:</label>
      <input type="text" id="USER" name="USER" required readonly>

      <label for="UUID">UUID:</label>
      <input type="text" id="UUID" name="UUID" required readonly>

      <label for="PATENTE">PATENTE (Formato AAAA-00 o AA00-00):</label>
      <input
        type="text"
        id="PATENTE"
        name="PATENTE"
        pattern="^[A-Z]{2,4}-[0-9]{2}$"
        title="Debe cumplir con el formato AAAA-00 o AA00-00"
        required
      />

      <label for="RESOLUCION">RESOLUCIÓN (decimal):</label>
      <input
        type="text"
        id="RESOLUCION"
        name="RESOLUCION"
        pattern="^\d+(\.\d+)?$"
        title="Debe ser un número decimal (float)"
        required
      />

      <label for="TARIFA_INICIAL">TARIFA INICIAL (número):</label>
      <input
        type="number"
        id="TARIFA_INICIAL"
        name="TARIFA_INICIAL"
        min="1"
        step="1"
        title="Debe ser un número número"
        required
      />

      <label for="TARIFA_CAIDA_PARCIAL_METROS">TARIFA CAÍDA PARCIAL METROS (número):</label>
      <input
        type="number"
        id="TARIFA_CAIDA_PARCIAL_METROS"
        name="TARIFA_CAIDA_PARCIAL_METROS"
        min="1"
        step="1"
        required
      />

      <label for="TARIFA_CAIDA_PARCIAL_MINUTO">TARIFA CAÍDA PARCIAL MINUTO (número):</label>
      <input
        type="number"
        id="TARIFA_CAIDA_PARCIAL_MINUTO"
        name="TARIFA_CAIDA_PARCIAL_MINUTO"
        min="1"
        step="1"
        required
      />

      <label for="MOSTRAR_VELOCIDAD_EN_PANTALLA">MOSTRAR VELOCIDAD EN PANTALLA:</label>
      <select id="MOSTRAR_VELOCIDAD_EN_PANTALLA" name="MOSTRAR_VELOCIDAD_EN_PANTALLA" required>
        <option value="true">true</option>
        <option value="false">false</option>
      </select>

      <label for="COLOR_FONDO_PANTALLA">COLOR FONDO PANTALLA:</label>
      <select id="COLOR_FONDO_PANTALLA" name="COLOR_FONDO_PANTALLA" required>
        <option value="TFT_BLACK">TFT_BLACK</option>
        <option value="TFT_YELLOW">TFT_YELLOW</option>
        <option value="TFT_WHITE">TFT_WHITE</option>
      </select>

      <label for="COLOR_LETRAS_PANTALLA">COLOR LETRAS PANTALLA:</label>
      <select id="COLOR_LETRAS_PANTALLA" name="COLOR_LETRAS_PANTALLA" required>
        <option value="TFT_BLACK">TFT_YELLOW</option>
        <option value="TFT_YELLOW">TFT_BLACK</option>
        <option value="TFT_WHITE">TFT_WHITE</option>
      </select>

      <label for="COLOR_PRECIO_PANTALLA">COLOR PRECIO PANTALLA:</label>
      <select id="COLOR_PRECIO_PANTALLA" name="COLOR_PRECIO_PANTALLA" required>
        <option value="TFT_BLACK">TFT_WHITE</option>
        <option value="TFT_YELLOW">TFT_YELLOW</option>
        <option value="TFT_WHITE">TFT_BLACK</option>
      </select>

      <label for="PROPAGANDA_1">PROPAGANDA 1 (máx. 20 caracteres):</label>
      <input
        type="text"
        id="PROPAGANDA_1"
        name="PROPAGANDA_1"
        maxlength="20"
        required
      />

      <label for="PROPAGANDA_2">PROPAGANDA 2 (máx. 20 caracteres):</label>
      <input
        type="text"
        id="PROPAGANDA_2"
        name="PROPAGANDA_2"
        maxlength="20"
        required
      />

      <label for="PROPAGANDA_3">PROPAGANDA 3 (máx. 20 caracteres):</label>
      <input
        type="text"
        id="PROPAGANDA_3"
        name="PROPAGANDA_3"
        maxlength="20"
        required
      />

      <label for="PROPAGANDA_4">PROPAGANDA 4 (máx. 20 caracteres):</label>
      <input
        type="text"
        id="PROPAGANDA_4"
        name="PROPAGANDA_4"
        maxlength="20"
        required
      />

      <button type="submit">Ejecutar Job y Programar ESP32</button>
    </form>

    <h2>Logs:</h2>
    <div id="jobLogs"></div>

    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script>
      const socket = io();

      // Completar USER y UUID dinámicamente
      function initializeForm() {
        const email = "{{ email }}"; // Sustituido dinámicamente en el backend
        document.getElementById("USER").value = email.split("@")[0];
        document.getElementById("UUID").value = generateUUID();
      }

      // Generar un UUID
      function generateUUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0,
              v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }

      // Escuchar actualizaciones de log desde el servidor
      socket.on("log_update", (data) => {
        const logContainer = document.getElementById("jobLogs");
        logContainer.innerHTML += `<p><strong>Status:</strong> ${data.status}</p>`;
        logContainer.scrollTop = logContainer.scrollHeight;

        if (data.status.includes("ESP32 programado exitosamente")) {
          alert("¡El ESP32 ha sido programado con éxito!");
        }
      });

      // Escuchar actualizaciones de puertos
      socket.on("update_ports", (ports) => {
        const portSelect = document.getElementById("port");
        portSelect.innerHTML = ""; // Limpiar el selector antes de llenarlo

        if (ports.length > 0) {
          ports.forEach((port) => {
            const option = document.createElement("option");
            option.value = port.device;
            option.textContent = `${port.device} - ${port.hwid}`;
            portSelect.appendChild(option);
          });
        } else {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No se detectaron dispositivos";
          portSelect.appendChild(option);
        }
      });

      // Ejecutar trabajo y programar ESP32
      async function executeAndProgram(event) {
        event.preventDefault();
        const formData = new FormData(document.getElementById("jobForm"));
        const selectedPort = document.getElementById("port").value;

        if (!selectedPort) {
          alert("Debe seleccionar un puerto antes de ejecutar el trabajo.");
          return;
        }

        formData.append("port", selectedPort);
        const logContainer = document.getElementById("jobLogs");
        logContainer.innerHTML = `<p><strong>Status:</strong> Comenzó la ejecución del trabajo y la programación.</p>`;

        try {
          const response = await fetch("/execute_and_program", {
            method: "POST",
            body: formData,
          });
          const result = await response.json();

          if (result.status !== "success") {
            logContainer.innerHTML += `<p><strong>Status:</strong> Error: ${result.message}</p>`;
            alert(`Error: ${result.message}`);
          }
        } catch (error) {
          logContainer.innerHTML += `<p><strong>Status:</strong> Error: ${error.message}</p>`;
          alert(`Error al ejecutar el trabajo: ${error.message}`);
        }
      }


      function validateForm(event) {
        const patenteField = document.getElementById("PATENTE");
        const resolucionField = document.getElementById("RESOLUCION");

        // Validar patente
        const patenteRegex = /^[A-Z]{2,4}-[0-9]{2}$/;
        if (!patenteRegex.test(patenteField.value)) {
          alert("La patente debe tener el formato AAAA-00 o AA00-00.");
          event.preventDefault();
          return false;
        }

        // Validar resolución como float
        const resolucionRegex = /^\d+(\.\d+)?$/;
        if (!resolucionRegex.test(resolucionField.value)) {
          alert("La resolución debe ser un número decimal (float).");
          event.preventDefault();
          return false;
        }

        // Si todo es válido
        return true;
      }

      function logout() {
    // Confirmación del usuario
    if (!confirm("¿Estás seguro de que deseas cerrar sesión?")) {
        return;
    }

    // Eliminar el token del localStorage
    localStorage.removeItem('idToken');

    // Eliminar la cookie 'idToken'
    document.cookie = "idToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

    // Mostrar mensaje de cierre de sesión
    alert("Sesión cerrada correctamente.");

    // Redirigir al usuario a la página de inicio de sesión
    window.location.href = "/login";
}
    </script>
  </body>
</html>
